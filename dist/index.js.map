{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,MAAM,IAAI,CAAC;AACpB,OAAO,IAAI,MAAM,MAAM,CAAC;AACxB,OAAO,EAAE,QAAQ,EAAE,MAAM,MAAM,CAAC;AAEhC,OAAO,EAAE,MAAM,EAAE,MAAM,sBAAsB,CAAC;AAE9C,SAAS,UAAU,CAAC,GAAsB,EAAE,YAAsB;IAC9D,MAAM,YAAY,GAAgB,IAAI,GAAG,EAAE,CAAC;IAC5C,MAAM,YAAY,GAAgB,IAAI,GAAG,EAAE,CAAC;IAC5C,IAAI,YAAY,GAAG,IAAI,CAAC;IAExB,KAAK,UAAU,gBAAgB,CAAsB,QAAgB,EAAE,YAAsB;QACzF,MAAM,KAAK,GAAG,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;QAC1C,MAAM,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,QAAQ,CAAC,IAAI,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;QAC3E,MAAM,GAAG,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,WAAW,EAAE,CAAC;QACjD,IAAI,MAAuB,CAAC;QAE5B,IAAI,YAAY,IAAI,CAAC,OAAO,EAAE,MAAM,EAAE,OAAO,CAAC,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC;YAE3D,MAAM,GAAG,MAAM,MAAM,CAAC,EAAE,CAAC,YAAY,CAAC,QAAQ,EAAE,MAAM,CAAC,EAAE;gBACrD,kBAAkB,EAAE,IAAI;gBACxB,cAAc,EAAE,IAAI;gBACpB,SAAS,EAAE,IAAI;gBACf,QAAQ,EAAE,IAAI;aACjB,CAAC,CAAC;QACP,CAAC;aAAM,CAAC;YAEJ,MAAM,GAAG,EAAE,CAAC,YAAY,CAAC,QAAQ,CAAC,CAAC;QACvC,CAAC;QAED,IAAI,CAAC,QAAQ,CAAC;YACV,IAAI,EAAE,OAAO;YACb,QAAQ,EAAE,QAAQ;YAClB,MAAM;SACT,CAAC,CAAC;IACP,CAAC;IAED,MAAM,KAAK,GAAG,QAAQ,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;IAE7C,OAAO;QACH,IAAI,EAAE,aAAa;QACnB,UAAU;YACN,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE;gBACjB,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC;gBACxB,YAAY,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;gBAGvB,IAAI,YAAY,EAAE,CAAC;oBACf,gBAAgB,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,EAAE,YAAY,CAAC,CAAC;gBACpD,CAAC;YACL,CAAC,CAAC,CAAC;YAEH,YAAY,GAAG,KAAK,CAAC;QACzB,CAAC;QACD,WAAW,CAAC,EAAU;YAClB,IAAI,YAAY,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,CAAC;gBACvB,YAAY,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;YACzB,CAAC;QACL,CAAC;QACD,QAAQ;YAEJ,YAAY,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE;gBACxB,gBAAgB,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,EAAE,YAAY,CAAC,CAAC;YACpD,CAAC,CAAC,CAAC;YACH,YAAY,CAAC,KAAK,EAAE,CAAC;QACzB,CAAC;KACJ,CAAC;AACN,CAAC;AAED,eAAe,UAAU,CAAC","sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport { globSync } from 'glob';\nimport { PluginContext } from 'rollup';\nimport { minify } from 'html-minifier-terser';\n\nfunction copyPlugin(src: string | string[], shouldMinify?: boolean) {\n    const changedFiles: Set<string> = new Set();\n    const watchedFiles: Set<string> = new Set();\n    let isFirstBuild = true;\n\n    async function emitFileFromPath(this: PluginContext, filePath: string, shouldMinify?: boolean) {\n        const parts = filePath.split(path.sep)[0];\n        const destPath = path.relative(parts, filePath) || path.basename(filePath);\n        const ext = path.extname(filePath).toLowerCase();\n        let source: string | Buffer;\n\n        if (shouldMinify && ['.html', '.css', '.json'].includes(ext)) {\n            // console.log('压缩');\n            source = await minify(fs.readFileSync(filePath, 'utf8'), {\n                collapseWhitespace: true,\n                removeComments: true,\n                minifyCSS: true,\n                minifyJS: true,\n            });\n        } else {\n            // console.log('不压缩');\n            source = fs.readFileSync(filePath);\n        }\n\n        this.emitFile({\n            type: 'asset',\n            fileName: destPath,\n            source,\n        });\n    }\n\n    const files = globSync(src, { nodir: true });\n\n    return {\n        name: 'copy-plugin',\n        buildStart() {\n            files.forEach(file => {\n                this.addWatchFile(file);\n                watchedFiles.add(file);\n                // console.log('监视');\n\n                if (isFirstBuild) {\n                    emitFileFromPath.call(this, file, shouldMinify);\n                }\n            });\n\n            isFirstBuild = false;\n        },\n        watchChange(id: string) {\n            if (watchedFiles.has(id)) {\n                changedFiles.add(id);\n            }\n        },\n        buildEnd() {\n            // console.log('changedFiles', changedFiles);\n            changedFiles.forEach(file => {\n                emitFileFromPath.call(this, file, shouldMinify);\n            });\n            changedFiles.clear();\n        },\n    };\n}\n\nexport default copyPlugin;\n"]}